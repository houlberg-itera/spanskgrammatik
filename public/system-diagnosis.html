<!DOCTYPE html>
<html>
<head>
    <title>üî¨ Complete System Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .result { margin-top: 15px; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        h1 { text-align: center; color: #333; }
        h2 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>üî¨ Complete System Diagnosis</h1>
    
    <div class="test-section">
        <h2>Step 1: Load Sample Data</h2>
        <button class="button btn-primary" onclick="checkCurrentData()">üìä Check Current State</button>
        <button class="button btn-success" onclick="loadSampleData()">üì• Load Sample Data</button>
        <div id="dataResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Test Authentication</h2>
        <div style="margin: 10px 0;">
            <input type="email" id="email" placeholder="test@example.com" value="test@example.com" style="padding: 8px; margin: 5px;">
            <input type="password" id="password" placeholder="password123" value="password123" style="padding: 8px; margin: 5px;">
        </div>
        <button class="button btn-primary" onclick="checkAuth()">üîç Check Auth</button>
        <button class="button btn-success" onclick="registerUser()">‚ûï Register</button>
        <button class="button btn-warning" onclick="loginUser()">üîë Login</button>
        <div id="authResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Test Exercise Access</h2>
        <button class="button btn-primary" onclick="testExerciseFlow()">üéØ Full Exercise Test</button>
        <button class="button btn-warning" onclick="simulateProgressSaving()">üíæ Test Progress Saving</button>
        <div id="exerciseResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: Navigate to App</h2>
        <button class="button btn-success" onclick="openApp()">üöÄ Open Dashboard</button>
        <button class="button btn-primary" onclick="openLevel()">üìö Open A1 Level</button>
        <button class="button btn-warning" onclick="openAuth()">üîê Open Auth Page</button>
    </div>

    <script>
        function showResult(id, content, type = 'info') {
            const element = document.getElementById(id);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        // Step 1: Data functions
        async function checkCurrentData() {
            showResult('dataResult', 'Checking current database state...', 'info');
            try {
                const response = await fetch('/api/load-sample-data');
                const data = await response.json();
                showResult('dataResult', `üìä CURRENT DATABASE STATE:\\n\\nTotal Exercises: ${data.totalExercises}\\n\\nExercises:\\n${JSON.stringify(data.exercises, null, 2)}`, 'info');
            } catch (error) {
                showResult('dataResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        async function loadSampleData() {
            showResult('dataResult', 'Loading sample data...', 'info');
            try {
                const response = await fetch('/api/load-sample-data-simple', {
                    method: 'POST'
                });
                const data = await response.json();
                
                let resultText = 'üì• SAMPLE DATA LOAD RESULT:\\n\\n';
                resultText += `Summary: ${data.summary.successful} successful, ${data.summary.skipped} skipped, ${data.summary.errors} errors\\n`;
                resultText += `Total exercises in DB: ${data.totalExercisesInDB}\\n\\n`;
                resultText += 'Details:\\n' + JSON.stringify(data.results, null, 2);
                
                showResult('dataResult', resultText, data.summary.successful > 0 ? 'success' : 'error');
                
                // Auto-check current state after loading
                setTimeout(checkCurrentData, 1000);
                
            } catch (error) {
                showResult('dataResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // Step 2: Auth functions
        async function checkAuth() {
            showResult('authResult', 'Checking authentication status...', 'info');
            try {
                const response = await fetch('/api/auth-test');
                const data = await response.json();
                
                let resultText = 'üîç AUTHENTICATION STATUS:\\n\\n';
                resultText += `User authenticated: ${data.authentication.hasUser}\\n`;
                resultText += `User ID: ${data.authentication.userId || 'None'}\\n`;
                resultText += `Email: ${data.authentication.email || 'None'}\\n`;
                resultText += `Status: ${data.authentication.status}\\n`;
                
                if (data.authentication.authError) {
                    resultText += `Error: ${data.authentication.authError}\\n`;
                }
                
                if (data.databaseAccess) {
                    resultText += '\\nDatabase Access:\\n' + JSON.stringify(data.databaseAccess, null, 2);
                }
                
                showResult('authResult', resultText, data.authentication.hasUser ? 'success' : 'error');
                
            } catch (error) {
                showResult('authResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        async function registerUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showResult('authResult', 'Registering user...', 'info');
            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, fullName: 'Test User' })
                });
                const data = await response.json();
                
                let resultText = '‚ûï REGISTRATION RESULT:\\n\\n';
                resultText += JSON.stringify(data, null, 2);
                
                showResult('authResult', resultText, data.success ? 'success' : 'error');
                
                if (data.success) {
                    setTimeout(checkAuth, 1000);
                }
                
            } catch (error) {
                showResult('authResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        async function loginUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showResult('authResult', 'Logging in user...', 'info');
            try {
                const response = await fetch('/api/auth-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', email, password })
                });
                const data = await response.json();
                
                let resultText = 'üîë LOGIN RESULT:\\n\\n';
                resultText += JSON.stringify(data, null, 2);
                
                showResult('authResult', resultText, data.success ? 'success' : 'error');
                
                if (data.success) {
                    setTimeout(checkAuth, 1000);
                }
                
            } catch (error) {
                showResult('authResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // Step 3: Exercise functions
        async function testExerciseFlow() {
            showResult('exerciseResult', 'Testing complete exercise flow...', 'info');
            
            try {
                // 1. Check if we have exercises
                const dataResponse = await fetch('/api/load-sample-data');
                const dataResult = await dataResponse.json();
                
                let resultText = 'üéØ EXERCISE FLOW TEST:\\n\\n';
                resultText += `Available exercises: ${dataResult.totalExercises}\\n\\n`;
                
                if (dataResult.totalExercises < 3) {
                    resultText += '‚ö†Ô∏è Warning: Need more exercises for proper testing.\\n';
                    resultText += 'Please load sample data first.\\n\\n';
                }
                
                // 2. Check authentication
                const authResponse = await fetch('/api/auth-test');
                const authResult = await authResponse.json();
                
                resultText += `Authentication: ${authResult.authentication.status}\\n`;
                
                if (!authResult.authentication.hasUser) {
                    resultText += '‚ö†Ô∏è Warning: User not authenticated. Please login first.\\n\\n';
                }
                
                // 3. Test access to protected routes
                try {
                    const levelResponse = await fetch('/level/a1');
                    resultText += `Level page access: ${levelResponse.status === 200 ? '‚úÖ Success' : '‚ùå Failed (' + levelResponse.status + ')'}\\n`;
                } catch (e) {
                    resultText += `Level page access: ‚ùå Error - ${e.message}\\n`;
                }
                
                showResult('exerciseResult', resultText, 'info');
                
            } catch (error) {
                showResult('exerciseResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        async function simulateProgressSaving() {
            showResult('exerciseResult', 'Testing progress saving...', 'info');
            
            try {
                // Check auth first
                const authResponse = await fetch('/api/auth-test');
                const authResult = await authResponse.json();
                
                let resultText = 'üíæ PROGRESS SAVING TEST:\\n\\n';
                
                if (!authResult.authentication.hasUser) {
                    resultText += '‚ùå Cannot test progress saving: User not authenticated\\n';
                    resultText += 'Please login first using the authentication section above.\\n';
                    showResult('exerciseResult', resultText, 'error');
                    return;
                }
                
                resultText += `‚úÖ User authenticated: ${authResult.authentication.email}\\n\\n`;
                
                // Try to call the update_user_progress RPC function
                if (authResult.databaseAccess && authResult.databaseAccess.rpcTest) {
                    resultText += 'RPC Test Result:\\n';
                    resultText += JSON.stringify(authResult.databaseAccess.rpcTest, null, 2);
                } else {
                    resultText += 'RPC test not available in auth check.\\n';
                    resultText += 'This suggests the user can authenticate but may have database access issues.\\n';
                }
                
                showResult('exerciseResult', resultText, 'info');
                
            } catch (error) {
                showResult('exerciseResult', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // Step 4: Navigation functions
        function openApp() {
            window.open('/dashboard', '_blank');
        }

        function openLevel() {
            window.open('/level/a1', '_blank');
        }

        function openAuth() {
            window.open('/auth', '_blank');
        }

        // Auto-run diagnostics
        window.onload = function() {
            console.log('Starting automatic diagnostics...');
            checkCurrentData();
            setTimeout(checkAuth, 500);
        };
    </script>
</body>
</html>
